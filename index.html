<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centro de Mando V7: Bio-Tactical</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2666/2666505.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        
        body { background-color: #000; touch-action: none; overscroll-behavior: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Efecto Cristal (Glass) - Drawer */
        .glass-panel {
            background: rgba(10, 10, 10, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.8);
        }

        /* Animación Drawer */
        .drawer-transition { transition: height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* Animación Bio Scan */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .bio-scan::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: scanline 2s linear infinite; pointer-events: none;
        }

        /* Brillo Neon Personalizado */
        .neon-border {
            box-shadow: 0 0 10px var(--theme-color), inset 0 0 5px var(--theme-color);
        }
        
        /* Drag and Drop Styles */
        .droppable-area {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .droppable-area.drag-over {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--theme-color);
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.05);
        }
        .draggable-item {
            cursor: grab;
        }
        .draggable-item:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Calendar, CheckSquare, Settings, RefreshCw, Plus, ChevronLeft, ChevronRight, Menu, X, 
            Target, Folder, BookOpen, Clock, Trash2, Edit3, GripHorizontal, AlertTriangle, LogIn, CheckCircle,
            Dna, Microscope, Activity, Leaf, Zap, Globe, Database, Cpu, Layout, PenTool, Hash, Briefcase, Terminal, Layers,
            GraduationCap, ClipboardList, Move
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- ICON MAP ---
        const ICON_MAP = { 
            Calendar, CheckSquare, Target, Folder, BookOpen, Menu, Settings, Clock, 
            Dna, Microscope, Activity, Leaf, Zap, Globe, Database, Cpu, Layout, PenTool, Hash, Briefcase, Terminal
        };
        
        // --- BIO DATABASE VERIFIED ---
        const BIO_DB = [
            {
                id: 1, name: "Cuervo Grande", scientific: "Corvus corax",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Chordata", class: "Aves", 
                    order: "Passeriformes", family: "Corvidae", genus: "Corvus"
                },
                desc: "El paseriforme más pesado. Posee una inteligencia comparable a la de los primates, capaz de usar herramientas, resolver problemas complejos y planificar a futuro.",
                fact: "Los córvidos pueden reconocer rostros humanos individuales y guardar rencor o gratitud durante años.",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Corvus_corax_%28Common_Raven%29.jpg/800px-Corvus_corax_%28Common_Raven%29.jpg" 
            },
            {
                id: 2, name: "Araña Saltadora Audaz", scientific: "Phidippus audax",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Arthropoda", class: "Arachnida", 
                    order: "Araneae", family: "Salticidae", genus: "Phidippus"
                },
                desc: "Depredador visual activo con quelíceros iridiscentes (verde/azul). Su visión estereoscópica es excepcional, permitiéndole calcular distancias precisas para cazar sin telaraña.",
                fact: "Pueden saltar hasta 50 veces la longitud de su cuerpo gracias a cambios rápidos en la presión hemolinfática.",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Phidippus_audax_male.jpg/800px-Phidippus_audax_male.jpg"
            },
            {
                id: 3, name: "Tardígrado Modelo", scientific: "Hypsibius dujardini",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Tardigrada", class: "Eutardigrada", 
                    order: "Parachela", family: "Hypsibiidae", genus: "Hypsibius"
                },
                desc: "Micro-animal extremófilo utilizado como organismo modelo. A diferencia de otras especies, no entra en tun (criptobiosis) tan fácilmente, pero su genoma es clave para entender la reparación del ADN.",
                fact: "Posee una proteína única (Dsup) que suprime el daño al ADN inducido por radiación extrema.",
                img: "https://upload.wikimedia.org/wikipedia/commons/0/06/Hypsibius_dujardini.jpg" 
            },
            {
                id: 4, name: "Camarón Mantis", scientific: "Odontodactylus scyllarus",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Arthropoda", class: "Malacostraca", 
                    order: "Stomatopoda", family: "Odontodactylidae", genus: "Odontodactylus"
                },
                desc: "Posee los ojos más complejos del reino animal y apéndices raptores capaces de golpear con la aceleración de una bala calibre .22, generando cavitación bajo el agua.",
                fact: "Sus ojos pueden ver luz polarizada circularmente y 12 canales de color (humanos ven 3).",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Odontodactylus_scyllarus_1.jpg/800px-Odontodactylus_scyllarus_1.jpg"
            },
            {
                id: 5, name: "Dragón Azul", scientific: "Glaucus atlanticus",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Mollusca", class: "Gastropoda", 
                    order: "Nudibranchia", family: "Glaucidae", genus: "Glaucus"
                },
                desc: "Nudibranquio pelágico que flota boca abajo usando la tensión superficial. Se alimenta de la carabela portuguesa y roba sus nematocistos (células urticantes) para su propia defensa.",
                fact: "Concentra el veneno de sus presas, haciéndolo más peligroso que la medusa que comió.",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Glaucus_atlanticus_1.jpg/800px-Glaucus_atlanticus_1.jpg" 
            },
             {
                id: 6, name: "Medusa Inmortal", scientific: "Turritopsis dohrnii",
                taxonomy: {
                    kingdom: "Animalia", phylum: "Cnidaria", class: "Hydrozoa", 
                    order: "Anthoathecata", family: "Oceaniidae", genus: "Turritopsis"
                },
                desc: "Único animal conocido capaz de revertir su ciclo vital completo. Ante estrés o daño físico, transforma sus células (transdiferenciación) de medusa adulta a pólipo juvenil.",
                fact: "Biológicamente no muere por envejecimiento; su ciclo es teóricamente infinito.",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Turritopsis_dohrnii.jpg/640px-Turritopsis_dohrnii.jpg"
            }
        ];

        const DEFAULT_TABS = [
            { id: 'tab1', label: 'EVENTOS', iconKey: 'Calendar', color: '#3b82f6' },
            { id: 'tab2', label: 'TAREAS', iconKey: 'CheckSquare', color: '#ef4444' },
            { id: 'tab3', label: 'NOTAS', iconKey: 'BookOpen', color: '#eab308' },
            { id: 'tab4', label: 'PROYECTOS', iconKey: 'Folder', color: '#22c55e' },
        ];

        // Eisenhower Quadrants Definition
        const QUADRANTS = {
            q1: { id: 'q1', title: 'HACER YA', subtitle: 'Urgente + Importante', color: '#ef4444' },
            q2: { id: 'q2', title: 'PLANIFICAR', subtitle: 'No Urgente + Importante', color: '#3b82f6' },
            q3: { id: 'q3', title: 'DELEGAR', subtitle: 'Urgente + No Importante', color: '#eab308' },
            q4: { id: 'q4', title: 'ELIMINAR', subtitle: 'No Urgente + No Importante', color: '#64748b' }
        };

        function CommandCenterV7() {
            // --- ESTADOS ---
            const [tabs, setTabs] = useState(DEFAULT_TABS);
            const [activeTabId, setActiveTabId] = useState('tab1');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            
            // UI States
            const [modalMode, setModalMode] = useState(null); 
            const [selectedEventId, setSelectedEventId] = useState(null);
            // Added 'category' and 'quadrant' to default state
            const [eventFormData, setEventFormData] = useState({ 
                title: '', date: '', time: '', type: 'general', notes: '', 
                category: 'task', // 'task' or 'class'
                quadrant: 'q2' // default to Plan
            });
            const [showSettings, setShowSettings] = useState(false);
            const [editingTabId, setEditingTabId] = useState(null); 

            // Bio States
            const [bioIndex, setBioIndex] = useState(0); // Store index, not object
            const [showBioModal, setShowBioModal] = useState(false);

            // Google Sync
            const [isSyncing, setIsSyncing] = useState(false);
            const [googleConfig, setGoogleConfig] = useState({ apiKey: '', clientId: '' });
            const [isGoogleSignedIn, setIsGoogleSignedIn] = useState(false);

            // Drawer
            const [drawerHeight, setDrawerHeight] = useState(40); 
            const [isDragging, setIsDragging] = useState(false);
            const dragStartY = useRef(0);
            const dragStartHeight = useRef(0);
            
            // Drag and Drop State for Kanban
            const [draggedEventId, setDraggedEventId] = useState(null);

            const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];
            const themeStyle = { '--theme-color': activeTab.color, '--theme-glow': `${activeTab.color}60` };
            const bioOrganism = BIO_DB[bioIndex];

            // --- INIT ---
            useEffect(() => {
                const savedEvents = localStorage.getItem('cmd_events_v7');
                const savedTabs = localStorage.getItem('cmd_tabs_v7');
                const savedConfig = localStorage.getItem('cmd_google_config');
                
                if (savedEvents) {
                    // Migration: Ensure old events have new fields
                    const parsed = JSON.parse(savedEvents);
                    const migrated = parsed.map(ev => ({
                        ...ev,
                        category: ev.category || 'task',
                        quadrant: ev.quadrant || 'q2'
                    }));
                    setEvents(migrated);
                }
                else setEvents([{ id: 1, title: 'INIT_SYSTEM_V7', date: new Date().toISOString().split('T')[0], time: '09:00', type: 'work', category: 'task', quadrant: 'q1' }]);
                
                if (savedTabs) setTabs(JSON.parse(savedTabs));
                if (savedConfig) setGoogleConfig(JSON.parse(savedConfig));
                
                loadGoogleScripts();
            }, []);

            useEffect(() => { localStorage.setItem('cmd_events_v7', JSON.stringify(events)); }, [events]);
            useEffect(() => { localStorage.setItem('cmd_tabs_v7', JSON.stringify(tabs)); }, [tabs]);
            useEffect(() => { localStorage.setItem('cmd_google_config', JSON.stringify(googleConfig)); }, [googleConfig]);

            // --- GOOGLE SYNC & CALENDAR LOGIC (CORREGIDO) ---
            
            // 1. Cargar el script base de Google al inicio
            useEffect(() => {
                if(!document.getElementById('gapi-script')) {
                    const script = document.createElement("script");
                    script.id = 'gapi-script';
                    script.src = "https://apis.google.com/js/api.js";
                    script.onload = () => { 
                        window.gapi.load('client:auth2', () => {
                            // Intentar init silencioso si ya hay claves guardadas
                            if (googleConfig.apiKey && googleConfig.clientId) {
                                initGapiClient(true); 
                            }
                        }); 
                    };
                    document.body.appendChild(script);
                }
            }, []);

            // 2. Función de Inicialización Robusta
            const initGapiClient = async (silent = false) => {
                if (!window.gapi || !window.gapi.client) return;
                
                try {
                    await window.gapi.client.init({
                        apiKey: googleConfig.apiKey,
                        clientId: googleConfig.clientId,
                        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
                        scope: "https://www.googleapis.com/auth/calendar.events.readonly",
                    });
                    
                    // Escuchar cambios de estado
                    const authInstance = window.gapi.auth2.getAuthInstance();
                    setIsGoogleSignedIn(authInstance.isSignedIn.get());
                    authInstance.isSignedIn.listen(setIsGoogleSignedIn);
                    
                } catch (error) {
                    console.error("Error GAPI Init:", error);
                    // Solo mostramos alerta si NO es silencioso (cuando el usuario da click)
                    if (!silent) alert("⚠️ ERROR DE CONFIGURACIÓN:\n" + JSON.stringify(error.result || error, null, 2) + "\n\nRevisa: 1. Orígenes JS en Google Cloud. 2. Que Client ID sea correcto.");
                }
            };

            // 3. Manejador del Botón CONECTAR (Ahora fuerza el inicio)
            const handleGoogleAuth = async () => {
                if (!googleConfig.apiKey || !googleConfig.clientId) {
                    alert("⚠️ FALTAN DATOS: Por favor ingresa tu API Key y Client ID en los campos de texto.");
                    return;
                }

                if (!window.gapi) {
                    alert("⚠️ ERROR DE RED: No se ha podido cargar la librería de Google. Revisa tu conexión.");
                    return;
                }

                // Si no se ha inicializado auth2, forzamos la inicialización ahora
                if (!window.gapi.auth2 || !window.gapi.auth2.getAuthInstance()) {
                    await initGapiClient(false); // False = Mostrar errores si falla
                }

                // Intentar Login/Logout
                const auth2 = window.gapi.auth2.getAuthInstance();
                if (auth2) {
                    if (auth2.isSignedIn.get()) {
                        auth2.signOut();
                    } else {
                        try {
                            await auth2.signIn();
                        } catch (err) {
                            alert("⚠️ ERROR DE LOGIN: " + JSON.stringify(err, null, 2));
                        }
                    }
                }
            };

            const syncEvents = async () => {
                setIsSyncing(true);
                if (!isGoogleSignedIn) { 
                    handleGoogleAuth(); // Si le dan a Sync sin estar logueados, intentar loguear
                    setIsSyncing(false); 
                    return; 
                }
                try {
                    const response = await window.gapi.client.calendar.events.list({
                        'calendarId': 'primary', 'timeMin': (new Date()).toISOString(),
                        'showDeleted': false, 'singleEvents': true, 'maxResults': 50, 'orderBy': 'startTime'
                    });
                    const gEvents = response.result.items.map(item => ({
                        id: item.id, title: item.summary,
                        date: item.start.dateTime ? item.start.dateTime.split('T')[0] : item.start.date,
                        time: item.start.dateTime ? item.start.dateTime.split('T')[1].substring(0,5) : '',
                        type: 'google', notes: item.description || '',
                        category: 'task', quadrant: 'q2'
                    }));
                    
                    // Mezclar eventos evitando duplicados de Google anteriores
                    const localEvents = events.filter(e => e.type !== 'google');
                    setEvents([...localEvents, ...gEvents]);
                    alert(`✅ Sincronización exitosa: ${gEvents.length} eventos cargados.`);
                } catch (err) { 
                    console.error(err);
                    alert("⚠️ Error al sincronizar: " + JSON.stringify(err));
                } 
                finally { setIsSyncing(false); }
            };

            const days = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const d = [];
                const startPadding = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; 
                for (let i = 0; i < startPadding; i++) d.push({ day: '', date: null, isPadding: true });
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    d.push({ day: i, date: new Date(year, month, i).toISOString().split('T')[0], isPadding: false });
                }
                return d;
            }, [currentDate]);

            // --- LOGIC: HANDLE WIDGET CLICK (NO DUPLICATES) ---
            const handleWidgetClick = () => {
                let newIndex;
                if (BIO_DB.length > 1) {
                    do {
                        newIndex = Math.floor(Math.random() * BIO_DB.length);
                    } while (newIndex === bioIndex); // Ensure it's different
                } else {
                    newIndex = 0;
                }
                setBioIndex(newIndex);
                setShowBioModal(true);
            };

            // --- KANBAN / EISENHOWER LOGIC ---
            const handleDragStart = (e, eventId) => {
                setDraggedEventId(eventId);
                e.dataTransfer.effectAllowed = "move";
                // Invisible drag image or default
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                e.currentTarget.classList.remove('drag-over');
            };

            const handleDrop = (e, targetQuadrantId) => {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                if (!draggedEventId) return;

                setEvents(prev => prev.map(ev => 
                    ev.id === draggedEventId ? { ...ev, quadrant: targetQuadrantId } : ev
                ));
                setDraggedEventId(null);
            };

            // --- DRAWER HANDLERS ---
            const handleTouchStart = (e) => {
                setIsDragging(true);
                dragStartY.current = e.touches[0].clientY;
                dragStartHeight.current = drawerHeight;
            };

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                const deltaY = dragStartY.current - e.touches[0].clientY; 
                const newHeight = Math.min(window.innerHeight - 50, Math.max(40, dragStartHeight.current + deltaY));
                setDrawerHeight(newHeight);
            };

            const handleTouchEnd = () => {
                setIsDragging(false);
                const screenH = window.innerHeight;
                if (drawerHeight > screenH * 0.75) setDrawerHeight(screenH - 20);
                else if (drawerHeight > screenH * 0.3) setDrawerHeight(screenH * 0.5);
                else setDrawerHeight(40);
            };

            const eventsByDate = useMemo(() => {
                const grouped = {};
                events.forEach(ev => {
                    if (!grouped[ev.date]) grouped[ev.date] = [];
                    grouped[ev.date].push(ev);
                });
                return Object.keys(grouped).sort().map(date => ({ date, items: grouped[date] }));
            }, [events]);

            // --- RENDER ---
            return React.createElement('div', { 
                className: "h-screen w-screen bg-black text-slate-200 font-sans overflow-hidden flex flex-col relative",
                style: themeStyle
            }, [
                // Background
                React.createElement('div', { className: "absolute inset-0 pointer-events-none" }, 
                    React.createElement('div', { className: "absolute inset-0 opacity-10", style: { backgroundImage: `radial-gradient(circle at 50% 0%, var(--theme-color), transparent 80%)` } }),
                    React.createElement('div', { className: "absolute inset-0 opacity-20", style: { backgroundImage: `linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px)`, backgroundSize: '40px 40px' } })
                ),

                // 1. HEADER
                React.createElement('header', { className: "relative z-20 flex flex-col pt-2 bg-black/90 border-b border-white/10 shrink-0" }, 
                    React.createElement('div', { className: "flex overflow-x-auto no-scrollbar px-4 gap-2" }, 
                        tabs.map(tab => {
                            const Icon = ICON_MAP[tab.iconKey] || Menu;
                            const isActive = activeTabId === tab.id;
                            return React.createElement('button', {
                                key: tab.id, onClick: () => setActiveTabId(tab.id),
                                style: { borderColor: isActive ? tab.color : 'transparent', color: isActive ? tab.color : '#525252', backgroundColor: isActive ? `${tab.color}10` : 'transparent' },
                                className: "flex items-center gap-2 px-6 py-4 rounded-t-lg text-sm font-black tracking-widest transition-all duration-300 border-b-4 hover:bg-white/5 uppercase shrink-0"
                            }, [React.createElement(Icon, { size: 18, strokeWidth: 2.5 }), tab.label])
                        })
                    )
                ),

                // 2. MAIN AREA SWITCH
                React.createElement('main', { className: "flex-1 px-2 pb-2 md:px-6 md:pb-8 overflow-hidden flex flex-col relative z-10" }, 
                    // HEADER OF MAIN (Month/Year or Title)
                    React.createElement('div', { className: "py-4 flex flex-row items-center justify-between shrink-0" }, [
                        React.createElement('div', { className: "flex flex-col md:flex-row md:items-baseline gap-2" }, [
                            activeTabId === 'tab2' 
                                ? React.createElement('h1', { className: "text-4xl md:text-5xl font-black text-white tracking-tighter m-0 leading-none" }, "MATRIZ TÁCTICA")
                                : React.createElement('h1', { className: "text-4xl md:text-5xl font-black text-white tracking-tighter m-0 leading-none" }, currentDate.toLocaleString('es-ES', { month: 'long' }).toUpperCase()),
                            activeTabId === 'tab1' && React.createElement('span', { className: "text-neutral-500 font-bold text-2xl" }, currentDate.getFullYear())
                        ]),
                        React.createElement('div', { className: "flex items-center gap-3" }, [
                            activeTabId === 'tab1' && React.createElement('div', { className: "hidden md:flex items-center bg-neutral-900 border border-neutral-800 rounded-lg p-1 mr-2" }, [
                                React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)), className: "p-2 text-neutral-400 hover:text-white" }, React.createElement(ChevronLeft, { size: 20 })),
                                React.createElement('button', { onClick: () => setCurrentDate(new Date()), className: "px-2 text-xs font-bold text-neutral-400 hover:text-white" }, "HOY"),
                                React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)), className: "p-2 text-neutral-400 hover:text-white" }, React.createElement(ChevronRight, { size: 20 }))
                            ]),
                             // Add Task Button (visible in Tab 2 specifically, or general)
                             activeTabId === 'tab2' && React.createElement('button', { 
                                onClick: () => { setEventFormData({ title: '', date: new Date().toISOString().split('T')[0], time: '09:00', type: 'general', notes: '', category: 'task', quadrant: 'q1' }); setModalMode('create'); },
                                className: "flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--theme-color)] text-black font-black text-xs hover:brightness-110 shadow-[0_0_10px_var(--theme-glow)]"
                            }, [React.createElement(Plus, { size: 16 }), "NUEVA TAREA"]),
                            
                            React.createElement('button', { 
                                onClick: syncEvents,
                                className: `flex items-center gap-2 px-3 py-2 rounded-lg border bg-neutral-900 active:scale-95 transition-all ${isSyncing ? 'border-[var(--theme-color)] text-[var(--theme-color)]' : 'border-neutral-800 text-neutral-400'}`
                            }, [React.createElement(RefreshCw, { size: 18, className: isSyncing ? 'animate-spin' : '' }), React.createElement('span', { className: "hidden md:inline text-[10px] font-black" }, "SYNC")]),
                            React.createElement('button', { onClick: () => setShowSettings(true), className: "p-2.5 rounded-lg bg-neutral-900 border border-neutral-800 text-neutral-400 hover:text-white hover:border-white transition-colors" }, React.createElement(Settings, { size: 20 }))
                        ])
                    ]),

                    // CONTENT SWITCH: CALENDAR VS KANBAN
                    activeTabId === 'tab2' 
                    ? // --- EISENHOWER / KANBAN VIEW ---
                      React.createElement('div', { className: "flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-2 md:gap-4 pb-20 md:pb-0" }, 
                        ['q1', 'q2', 'q3', 'q4'].map(qKey => {
                            const qData = QUADRANTS[qKey];
                            const qEvents = events.filter(e => (e.quadrant || 'q2') === qKey);
                            
                            return React.createElement('div', { 
                                key: qKey,
                                onDragOver: handleDragOver,
                                onDragLeave: handleDragLeave,
                                onDrop: (e) => handleDrop(e, qKey),
                                className: "droppable-area bg-neutral-900/40 border border-neutral-800/60 rounded-xl p-3 flex flex-col relative overflow-hidden backdrop-blur-sm"
                            }, [
                                // Quadrant Header
                                React.createElement('div', { className: "flex justify-between items-center mb-3 pb-2 border-b border-white/5" }, [
                                    React.createElement('div', { className: "flex flex-col" }, [
                                        React.createElement('h3', { className: "text-sm font-black tracking-widest", style: { color: qData.color } }, qData.title),
                                        React.createElement('span', { className: "text-[9px] text-neutral-500 font-mono uppercase" }, qData.subtitle)
                                    ]),
                                    React.createElement('span', { className: "bg-neutral-800 text-neutral-400 text-[10px] font-bold px-2 py-0.5 rounded-full" }, qEvents.length)
                                ]),
                                // Quadrant List
                                React.createElement('div', { className: "flex-1 overflow-y-auto space-y-2 no-scrollbar" }, 
                                    qEvents.map(ev => React.createElement('div', {
                                        key: ev.id,
                                        draggable: true,
                                        onDragStart: (e) => handleDragStart(e, ev.id),
                                        onClick: () => { setEventFormData({ ...ev }); setSelectedEventId(ev.id); setModalMode('edit'); },
                                        className: "draggable-item bg-black/60 border border-neutral-800 hover:border-white/30 p-2.5 rounded-lg group transition-all active:scale-95"
                                    }, [
                                        React.createElement('div', { className: "flex items-start gap-2" }, [
                                            // Icon based on Category
                                            React.createElement('div', { className: `mt-0.5 ${ev.category === 'class' ? 'text-blue-400' : 'text-emerald-400'}` }, 
                                                ev.category === 'class' 
                                                    ? React.createElement(GraduationCap, { size: 14 }) // Class Icon
                                                    : React.createElement(CheckCircle, { size: 14 })   // Task Icon
                                            ),
                                            React.createElement('div', { className: "flex-1 min-w-0" }, [
                                                React.createElement('p', { className: "text-xs font-bold text-white truncate leading-tight" }, ev.title),
                                                React.createElement('div', { className: "flex items-center gap-2 mt-1" }, [
                                                    ev.time && React.createElement('span', { className: "text-[9px] text-neutral-500 font-mono bg-neutral-900 px-1 rounded" }, ev.time),
                                                    ev.date && React.createElement('span', { className: "text-[9px] text-neutral-600 font-mono" }, ev.date.substring(5)) // Show MM-DD
                                                ])
                                            ]),
                                            React.createElement(GripHorizontal, { size: 14, className: "text-neutral-700 group-hover:text-neutral-500" })
                                        ])
                                    ]))
                                )
                            ])
                        })
                      )
                    : // --- CALENDAR VIEW (EXISTING) ---
                      React.createElement('div', { className: "flex-1 bg-neutral-900/30 backdrop-blur-sm rounded-xl border border-neutral-800 overflow-hidden flex flex-col relative shadow-[0_0_100px_rgba(0,0,0,0.5)]" }, [
                        React.createElement('div', { className: "grid grid-cols-7 bg-black border-b border-neutral-800" }, 
                            ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM'].map(day => React.createElement('div', { key: day, className: "py-2 text-center text-[10px] md:text-xs font-black tracking-[0.2em] text-neutral-600" }, day))
                        ),
                        React.createElement('div', { className: "grid grid-cols-7 flex-1 auto-rows-fr" }, 
                            days.map((dayObj, index) => {
                                if (dayObj.isPadding) return React.createElement('div', { key: index, className: "border-r border-b border-neutral-800/40 bg-neutral-950/40" });
                                const dayEvents = events.filter(e => e.date === dayObj.date);
                                const isToday = dayObj.date === new Date().toISOString().split('T')[0];
                                return React.createElement('div', {
                                    key: index,
                                    onClick: () => { setEventFormData({ title: '', date: dayObj.date, time: '09:00', type: 'general', notes: '', category: 'task', quadrant: 'q2' }); setModalMode('create'); },
                                    className: `relative border-r border-b border-neutral-800/40 p-1 md:p-2 transition-colors cursor-pointer group hover:bg-neutral-900 ${isToday ? 'bg-neutral-900/80' : ''}`
                                }, [
                                    React.createElement('span', { className: `text-xs font-bold flex items-center justify-center w-6 h-6 rounded ${isToday ? 'bg-[var(--theme-color)] text-black' : 'text-neutral-600 group-hover:text-white'}` }, dayObj.day),
                                    React.createElement('div', { className: "mt-1 flex flex-col gap-1 overflow-y-auto max-h-[80px] no-scrollbar" }, 
                                        dayEvents.map(event => React.createElement('div', {
                                            key: event.id,
                                            onClick: (e) => { e.stopPropagation(); setEventFormData({ ...event }); setSelectedEventId(event.id); setModalMode('edit'); },
                                            className: `text-[9px] md:text-[10px] font-bold truncate px-1.5 py-0.5 rounded border-l-[3px] hover:brightness-125 transition-transform ${event.type === 'google' ? 'bg-blue-900/30 text-blue-200 border-blue-500' : 'bg-neutral-800 text-neutral-300'}`,
                                            style: { borderLeftColor: event.type !== 'google' ? activeTab.color : undefined }
                                        }, [
                                            // Mini Icon in Calendar
                                            event.category === 'class' && React.createElement(GraduationCap, { size: 8, className: "inline mr-1" }),
                                            event.time ? `${event.time} ${event.title}` : event.title
                                        ]))
                                    )
                                ])
                            })
                        )
                    ])
                ),

                // 3. DRAWER
                React.createElement('div', { 
                    className: `fixed bottom-0 left-0 right-[60px] z-50 rounded-tr-2xl glass-panel flex flex-col ${!isDragging ? 'drawer-transition' : ''}`, 
                    style: { height: `${drawerHeight}px` }
                }, [
                    React.createElement('div', { 
                        className: "w-full h-8 flex items-center justify-center cursor-grab active:cursor-grabbing shrink-0 touch-none",
                        onTouchStart: handleTouchStart, onTouchMove: handleTouchMove, onTouchEnd: handleTouchEnd
                    }, React.createElement('div', { className: "w-16 h-1 bg-white/30 rounded-full" })),
                    
                    React.createElement('div', { className: "flex-1 overflow-x-auto p-4 flex gap-4 no-scrollbar" }, 
                        eventsByDate.length === 0 
                            ? React.createElement('div', { className: "w-full flex items-center justify-center text-neutral-500 font-bold tracking-widest text-xs" }, "BANDEJA VACÍA")
                            : eventsByDate.map(group => React.createElement('div', { key: group.date, className: "min-w-[220px] w-[220px] flex flex-col gap-2 opacity-90" }, [
                                React.createElement('div', { className: "text-[10px] font-black text-[var(--theme-color)] uppercase tracking-widest border-b border-white/10 pb-1 mb-2" }, 
                                    new Date(group.date).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })
                                ),
                                group.items.map(ev => React.createElement('div', { 
                                    key: ev.id,
                                    onClick: (e) => { setEventFormData({ ...ev }); setSelectedEventId(ev.id); setModalMode('edit'); },
                                    className: "bg-black/40 border border-white/10 p-3 rounded hover:border-[var(--theme-color)] transition-colors cursor-pointer backdrop-blur-sm"
                                }, [
                                    React.createElement('div', { className: "flex justify-between items-start mb-1" }, [
                                        React.createElement('span', { className: "text-xs font-bold text-white truncate flex items-center gap-1" }, [
                                            ev.category === 'class' && React.createElement(GraduationCap, { size: 10, className: "text-blue-400" }),
                                            ev.title
                                        ]),
                                        React.createElement('span', { className: "text-[9px] text-neutral-400 font-mono" }, ev.time)
                                    ]),
                                    ev.notes && React.createElement('div', { className: "text-[9px] text-neutral-500 line-clamp-2 italic" }, ev.notes)
                                ]))
                            ]))
                    )
                ]),

                // 4. BIO WIDGET
                React.createElement('div', {
                    onClick: handleWidgetClick, // CLICK TO CHANGE & OPEN
                    className: `fixed bottom-0 right-0 w-32 z-[60] flex items-center justify-center cursor-pointer hover:bg-black/50 active:scale-95 overflow-hidden rounded-tl-[30px] group shadow-[0_0_30px_rgba(0,0,0,0.8)] backdrop-blur-md ${!isDragging ? 'drawer-transition' : ''}`, 
                    style: { 
                        height: `${drawerHeight}px`, 
                        backgroundColor: 'rgba(0, 0, 0, 0.4)', 
                        borderLeft: `2px solid ${activeTab.color}`,
                        borderTop: `2px solid ${activeTab.color}`,
                        boxShadow: `0 0 20px ${activeTab.color}40, inset 0 0 10px ${activeTab.color}10`
                    } 
                }, [
                    React.createElement(Dna, { size: 28, className: "group-hover:animate-spin transition-transform duration-700", style: { color: activeTab.color } }),
                    React.createElement('div', { className: "absolute inset-0 bg-gradient-to-tr from-transparent to-white/10 pointer-events-none" })
                ]),

                // 5. SETTINGS MODAL
                showSettings && React.createElement('div', { className: "fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in" }, 
                    React.createElement('div', { className: "w-full max-w-2xl h-[80vh] bg-neutral-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col" }, [
                        React.createElement('div', { className: "p-4 bg-black flex justify-between items-center border-b border-neutral-800" }, [
                            React.createElement('h3', { className: "font-bold text-white flex gap-2" }, [React.createElement(Settings, { size: 18 }), "CONFIGURACIÓN"]),
                            React.createElement('button', { onClick: () => setShowSettings(false) }, React.createElement(X))
                        ]),
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6 space-y-6" }, [
                            React.createElement('div', { className: "space-y-4" }, [
                                React.createElement('h4', { className: "text-xs font-bold text-neutral-500 uppercase tracking-widest border-b border-neutral-800 pb-2" }, "Editor de Pestañas"),
                                React.createElement('div', { className: "space-y-3" }, tabs.map(tab => {
                                    const Icon = ICON_MAP[tab.iconKey] || Menu;
                                    return React.createElement('div', { key: tab.id, className: "bg-black border border-neutral-800 p-3 rounded-lg flex items-center gap-4" }, [
                                        React.createElement('div', { className: "relative w-8 h-8 rounded overflow-hidden border border-neutral-700" }, 
                                            React.createElement('input', { type: "color", value: tab.color, onChange: (e) => setTabs(tabs.map(t => t.id === tab.id ? {...t, color: e.target.value} : t)), className: "absolute -top-2 -left-2 w-16 h-16 cursor-pointer" })
                                        ),
                                        React.createElement('input', { className: "bg-transparent border-b border-neutral-800 text-white font-bold text-sm w-full focus:border-[var(--theme-color)] outline-none py-1", value: tab.label, onChange: (e) => setTabs(tabs.map(t => t.id === tab.id ? {...t, label: e.target.value} : t)) }),
                                        React.createElement('button', { onClick: () => setEditingTabId(editingTabId === tab.id ? null : tab.id), className: "p-2 bg-neutral-900 rounded hover:bg-neutral-800 text-neutral-400 hover:text-white" }, React.createElement(Icon, { size: 16 }))
                                    ])
                                })),
                                editingTabId && React.createElement('div', { className: "bg-neutral-900 p-4 rounded-lg border border-neutral-800 animate-in fade-in" }, 
                                    React.createElement('div', { className: "grid grid-cols-8 gap-2" }, Object.keys(ICON_MAP).map(key => {
                                        const IconItem = ICON_MAP[key];
                                        return React.createElement('button', { 
                                            key: key, 
                                            onClick: () => { setTabs(tabs.map(t => t.id === editingTabId ? {...t, iconKey: key} : t)); setEditingTabId(null); },
                                            className: "p-2 rounded hover:bg-neutral-800 flex justify-center text-neutral-400 hover:text-white transition-colors"
                                        }, React.createElement(IconItem, { size: 20 }))
                                    }))
                                )
                            ]),
                            React.createElement('div', { className: "space-y-2 pt-4" }, [
                                React.createElement('h4', { className: "text-xs font-bold text-neutral-500 uppercase tracking-widest border-b border-neutral-800 pb-2" }, "Google API (Sync)"),
                                React.createElement('div', { className: "p-3 bg-black/50 rounded border border-neutral-800 space-y-2" }, [
                                    React.createElement('input', { type: "password", placeholder: "Client ID", className: "w-full bg-transparent border-b border-neutral-700 text-xs p-1 text-white outline-none", value: googleConfig.clientId, onChange: (e) => setGoogleConfig({...googleConfig, clientId: e.target.value}) }),
                                    React.createElement('input', { type: "password", placeholder: "API Key", className: "w-full bg-transparent border-b border-neutral-700 text-xs p-1 text-white outline-none", value: googleConfig.apiKey, onChange: (e) => setGoogleConfig({...googleConfig, apiKey: e.target.value}) }),
                                    React.createElement('button', { onClick: handleGoogleAuth, className: `w-full py-2 mt-2 rounded text-xs font-bold ${isGoogleSignedIn ? 'bg-red-900/30 text-red-400' : 'bg-blue-900/30 text-blue-400'}` }, isGoogleSignedIn ? "DESCONECTAR" : "CONECTAR")
                                ])
                            ])
                        ])
                    ])
                ),

                // 6. EVENT MODAL (UPDATED WITH CATEGORY & QUADRANT)
                modalMode && React.createElement('div', { className: "fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-in fade-in" }, 
                    React.createElement('div', { className: "w-full max-w-md bg-neutral-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" }, [
                        React.createElement('div', { className: "p-4 bg-black flex justify-between items-center border-b border-neutral-800 shrink-0" }, [
                            React.createElement('span', { className: "font-bold text-white text-sm tracking-wider flex items-center gap-2" }, [
                                modalMode === 'edit' ? React.createElement(Edit3, { size: 16, className: "text-[var(--theme-color)]" }) : React.createElement(Plus, { size: 16, className: "text-[var(--theme-color)]" }),
                                modalMode === 'edit' ? "EDITAR DETALLES" : "NUEVA ENTRADA"
                            ]),
                            React.createElement('button', { onClick: () => setModalMode(null) }, React.createElement(X, { size: 20, className: "text-neutral-500" }))
                        ]),
                        React.createElement('div', { className: "p-5 space-y-4 overflow-y-auto" }, [
                            // CATEGORY SELECTOR (NEW)
                            React.createElement('div', { className: "flex gap-2 mb-2" }, [
                                { id: 'task', label: 'TAREA', icon: CheckSquare },
                                { id: 'class', label: 'CLASE', icon: GraduationCap }
                            ].map(cat => 
                                React.createElement('button', {
                                    key: cat.id,
                                    onClick: () => setEventFormData({...eventFormData, category: cat.id}),
                                    className: `flex-1 py-2 rounded-lg flex items-center justify-center gap-2 border text-xs font-black transition-all ${eventFormData.category === cat.id ? 'bg-[var(--theme-color)] text-black border-[var(--theme-color)]' : 'bg-transparent border-neutral-700 text-neutral-500'}`
                                }, [React.createElement(cat.icon, { size: 14 }), cat.label])
                            )),

                            React.createElement('input', { autoFocus: true, type: "text", placeholder: "Título...", className: "w-full bg-black border border-neutral-700 rounded p-3 text-white font-bold focus:border-[var(--theme-color)] outline-none", value: eventFormData.title, onChange: (e) => setEventFormData({...eventFormData, title: e.target.value}) }),
                            
                            // QUADRANT SELECTOR (If editing or creating, allows initial placement)
                            React.createElement('div', { className: "grid grid-cols-2 gap-2" }, 
                                Object.values(QUADRANTS).map(q => 
                                    React.createElement('button', {
                                        key: q.id,
                                        onClick: () => setEventFormData({...eventFormData, quadrant: q.id}),
                                        className: `p-2 rounded border text-[10px] font-bold uppercase transition-all ${eventFormData.quadrant === q.id ? 'bg-white/10 text-white' : 'bg-transparent text-neutral-600 border-neutral-800 hover:border-neutral-600'}`,
                                        style: { borderColor: eventFormData.quadrant === q.id ? q.color : undefined, color: eventFormData.quadrant === q.id ? q.color : undefined }
                                    }, q.title)
                                )
                            ),

                            React.createElement('div', { className: "grid grid-cols-2 gap-3" }, [
                                React.createElement('input', { type: "date", className: "w-full bg-black border border-neutral-700 rounded p-2 text-sm text-white", value: eventFormData.date, onChange: (e) => setEventFormData({...eventFormData, date: e.target.value}) }),
                                React.createElement('input', { type: "time", className: "w-full bg-black border border-neutral-700 rounded p-2 text-sm text-white", value: eventFormData.time, onChange: (e) => setEventFormData({...eventFormData, time: e.target.value}) }),
                            ]),
                            React.createElement('textarea', { rows: 4, className: "w-full bg-black border border-neutral-700 rounded p-3 text-sm text-neutral-300 focus:border-[var(--theme-color)] outline-none resize-none", placeholder: "Notas adicionales...", value: eventFormData.notes, onChange: (e) => setEventFormData({...eventFormData, notes: e.target.value}) }),
                            React.createElement('div', { className: "pt-2 flex gap-3" }, [
                                modalMode === 'edit' && React.createElement('button', { 
                                    onClick: () => { setEvents(events.filter(ev => ev.id !== selectedEventId)); setModalMode(null); },
                                    className: "p-3 rounded bg-red-900/20 text-red-500 border border-red-900 hover:bg-red-900/40"
                                }, React.createElement(Trash2, { size: 18 })),
                                React.createElement('button', { 
                                    onClick: () => {
                                        if (!eventFormData.title) return;
                                        if (modalMode === 'create') setEvents([...events, { id: Date.now(), ...eventFormData }]);
                                        else setEvents(events.map(ev => ev.id === selectedEventId ? { ...ev, ...eventFormData } : ev));
                                        setModalMode(null);
                                    },
                                    className: "flex-1 py-3 rounded bg-[var(--theme-color)] text-black font-black hover:brightness-110 shadow-[0_0_15px_var(--theme-glow)] uppercase tracking-widest"
                                }, "CONFIRMAR")
                            ])
                        ])
                    ])
                ),

                // 7. BIO ALMANAC MODAL
                showBioModal && bioOrganism && React.createElement('div', { className: "fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in" }, 
                    React.createElement('div', { 
                        className: "w-full max-w-3xl rounded-lg overflow-hidden flex flex-col md:flex-row relative shadow-2xl",
                        style: {
                            backgroundColor: 'rgba(10, 10, 10, 0.8)',
                            backdropFilter: 'blur(20px)',
                            borderColor: activeTab.color,
                            borderWidth: '1px',
                            boxShadow: `0 0 50px ${activeTab.color}20`
                        }
                    }, [
                        React.createElement('button', { 
                            onClick: () => setShowBioModal(false),
                            style: { color: activeTab.color, backgroundColor: 'rgba(0,0,0,0.5)' },
                            className: "absolute top-4 right-4 z-50 p-2 rounded-full hover:brightness-125"
                        }, React.createElement(X)),

                        React.createElement('div', { className: "w-full md:w-1/2 h-64 md:h-auto relative bio-scan overflow-hidden bg-black" }, [
                            React.createElement('img', { 
                                src: bioOrganism.img, 
                                className: "w-full h-full object-cover opacity-80",
                                onError: (e) => { 
                                    e.target.onerror = null; // Prevent infinite loop
                                    e.target.src = "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?auto=format&fit=crop&q=80&w=800"; // Generic DNA/Bio Fallback
                                }
                            }),
                            React.createElement('div', { className: "absolute bottom-0 left-0 p-4 bg-gradient-to-t from-black to-transparent w-full" }, 
                                React.createElement('h2', { className: "text-2xl font-black italic tracking-tighter text-white" }, bioOrganism.name.toUpperCase())
                            )
                        ]),
                        
                        React.createElement('div', { className: "w-full md:w-1/2 p-6 md:p-8 flex flex-col justify-center space-y-6 relative" }, [
                            React.createElement('div', { className: "absolute top-0 right-0 p-2 opacity-10", style: { color: activeTab.color } }, React.createElement(Microscope, { size: 100 })),
                            
                            React.createElement('div', { className: "space-y-3 border-l-4 pl-4", style: { borderLeftColor: activeTab.color } }, [
                                React.createElement('p', { className: "text-xs font-mono uppercase tracking-widest", style: { color: activeTab.color } }, "CLASIFICACIÓN TAXONÓMICA"),
                                React.createElement('p', { className: "text-lg font-serif italic text-white" }, bioOrganism.scientific),
                                React.createElement('p', { className: "text-xs text-neutral-400 italic" }, `Abrv: ${bioOrganism.taxonomy.genus} sp.`),
                                
                                React.createElement('div', { className: "grid grid-cols-2 gap-x-2 gap-y-1 mt-2 p-2 bg-white/5 rounded" }, [
                                    ['Reino', bioOrganism.taxonomy.kingdom],
                                    ['Filo', bioOrganism.taxonomy.phylum],
                                    ['Clase', bioOrganism.taxonomy.class],
                                    ['Orden', bioOrganism.taxonomy.order],
                                    ['Familia', bioOrganism.taxonomy.family],
                                    ['Género', bioOrganism.taxonomy.genus]
                                ].map(([label, val]) => 
                                    React.createElement('div', { key: label, className: "flex justify-between items-baseline text-[10px]" }, [
                                        React.createElement('span', { className: "text-neutral-500 font-bold" }, label),
                                        React.createElement('span', { className: "text-neutral-300" }, val)
                                    ])
                                ))
                            ]),

                            React.createElement('div', { className: "space-y-2" }, [
                                React.createElement('p', { className: "text-xs font-bold text-neutral-500 uppercase" }, "ANÁLISIS BIOLÓGICO"),
                                React.createElement('p', { className: "text-sm text-neutral-300 leading-relaxed" }, bioOrganism.desc)
                            ]),

                            React.createElement('div', { 
                                className: "p-4 rounded-lg border", 
                                style: { backgroundColor: `${activeTab.color}15`, borderColor: `${activeTab.color}40` } 
                            }, [
                                React.createElement('div', { className: "flex items-center gap-2 mb-2" }, [
                                    React.createElement(Activity, { size: 14, style: { color: activeTab.color } }),
                                    React.createElement('span', { className: "text-[10px] font-black uppercase", style: { color: activeTab.color } }, "DATO VITAL")
                                ]),
                                React.createElement('p', { className: "text-xs text-white opacity-80" }, bioOrganism.fact)
                            ])
                        ])
                    ])
                )
            ]);
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(CommandCenterV7));
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registrado: ', reg.scope))
            .catch(err => console.log('SW falló: ', err));
        });
      }
    </script>
</body>
</html>

