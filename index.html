<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CMD V16: Better</title>
<link rel="manifest" href="./manifest.json"><meta name="theme-color" content="#000">
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','sans-serif'],mono:['JetBrains Mono','Courier New','monospace']},animation:{'pulse-fast':'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite','scan':'scan 2s linear infinite'}} }}</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
body{background:#000;touch-action:none;overscroll-behavior:none;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent; color: #e2e8f0;}
.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
.glass { background: rgba(20, 20, 22, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
.ios-glass { background: rgba(30, 30, 35, 0.6); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
.hud-grid { background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 20px 20px; }
@keyframes scan { 0% {top: 0%} 50% {top: 100%} 100% {top: 0%} }
.scan-line { position: absolute; left:0; right:0; height: 2px; background: var(--theme-color); box-shadow: 0 0 15px var(--theme-color); opacity: 0.8; animation: scan 3s ease-in-out infinite; }
.safe-hover:hover { filter: brightness(1.2); }
#modal-root { position: fixed; inset: 0; z-index: 9999; pointer-events: auto; }

/* Smooth Month Animations */
.anim-n { animation: slideNext 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
.anim-p { animation: slidePrev 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
@keyframes slideNext { from { transform: translateX(20%); opacity: 0; filter: blur(5px); } to { transform: translateX(0); opacity: 1; filter: blur(0); } }
@keyframes slidePrev { from { transform: translateX(-20%); opacity: 0; filter: blur(5px); } to { transform: translateX(0); opacity: 1; filter: blur(0); } }

/* --- TV PURGE ANIMATION --- */
.anim-purge { animation: tvPurge 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards; transform-origin: center; pointer-events: none; will-change: transform, opacity, max-height, margin; }
@keyframes tvPurge {
    0% { transform: scale(1); opacity: 1; max-height: 80px; margin-bottom: 0.75rem; }
    100% { transform: scale(0, 0); opacity: 0; max-height: 0; margin-bottom: 0; padding: 0; border-width: 0; }
}
.tr-h { transition: height 0.4s cubic-bezier(0.32, 0.725, 0.25, 1); }

/* --- SNAPPY FOLDER ANIMATIONS --- */
.zoom-enter { animation: zoomInFolder 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
.zoom-exit { animation: zoomOutFolder 0.2s cubic-bezier(0.3, 0, 0, 1) forwards; }

@keyframes zoomInFolder {
    0% { opacity: 0; transform: scale(0.9); filter: blur(5px); }
    100% { opacity: 1; transform: scale(1); filter: blur(0); }
}
@keyframes zoomOutFolder {
    0% { opacity: 1; transform: scale(1); filter: blur(0); }
    100% { opacity: 0; transform: scale(1.05); filter: blur(5px); }
}

.card-press:active { transform: scale(0.97); transition: transform 0.1s; }

</style>
</head>
<body><div id="root"></div>
<script type="module">
import React,{useState,useEffect,useRef,useMemo,Component}from'https://esm.sh/react@18.2.0';
import{createRoot}from'https://esm.sh/react-dom@18.2.0/client';
import*as L from'https://esm.sh/lucide-react@0.292.0';

const h=React.createElement, F=React.Fragment;
const ICONS={
    Calendar:L.Calendar,CheckSquare:L.CheckSquare,BookOpen:L.BookOpen,Folder:L.Folder,Settings:L.Settings,
    Dna:L.Dna,Activity:L.Activity,Zap:L.Zap,GraduationCap:L.GraduationCap,Dumbbell:L.Dumbbell,
    X:L.X,RefreshCw:L.RefreshCw,Trash2:L.Trash2,GripHorizontal:L.GripHorizontal,CheckCircle:L.CheckCircle,
    Eye:L.Eye,EyeOff:L.EyeOff,Bell:L.Bell,Search:L.Search,Wifi:L.Wifi,WifiOff:L.WifiOff,
    Globe:L.Globe,Database:L.Database,Key:L.Key, AlertTriangle:L.AlertTriangle, CloudOff:L.CloudOff, Info:L.Info, 
    Plus:L.Plus, Save:L.Save, Check:L.Check, ArrowLeft:L.ArrowLeft, FileText:L.FileText, 
    Youtube:L.Youtube, Cloud:L.Cloud, File:L.File, ExternalLink:L.ExternalLink, MoreVertical:L.MoreVertical, Play:L.Play,
    Edit3:L.Edit3
};

const TAXONOMY_DB = {
    "Corvus corax": { k: "Animalia", p: "Chordata", c: "Aves", o: "Passeriformes", f: "Corvidae", g: "Corvus" },
    "Ambystoma mexicanum": { k: "Animalia", p: "Chordata", c: "Amphibia", o: "Caudata", f: "Ambystomatidae", g: "Ambystoma" },
    "Phidippus audax": { k: "Animalia", p: "Arthropoda", c: "Arachnida", o: "Araneae", f: "Salticidae", g: "Phidippus" },
    "Hymenopus coronatus": { k: "Animalia", p: "Arthropoda", c: "Insecta", o: "Mantodea", f: "Hymenopodidae", g: "Hymenopus" }
};
const SPECIES_LIST = Object.keys(TAXONOMY_DB);
const TABS=[{id:'t1',l:'EVENTOS',i:'Calendar',c:'#3b82f6'},{id:'t2',l:'TAREAS',i:'CheckSquare',c:'#ef4444'},{id:'t3',l:'NOTAS',i:'BookOpen',c:'#eab308'},{id:'t4',l:'PROY',i:'Folder',c:'#22c55e'}];
const Q={q1:{t:'HACER YA',s:'Urgente+Imp',c:'#ef4444'},q2:{t:'PLANIFICAR',s:'NoUrg+Imp',c:'#3b82f6'},q3:{t:'DELEGAR',s:'Urg+NoImp',c:'#eab308'},q4:{t:'ELIMINAR',s:'NiUrg+NiImp',c:'#64748b'}};

const locDate = (d) => {
    if(!(d instanceof Date) || isNaN(d)) return new Date().toISOString().split('T')[0];
    const z = d.getTimezoneOffset() * 60000;
    return new Date(d.getTime() - z).toISOString().split('T')[0];
};
const Icon=(n,s=18,c)=>h(ICONS[n]||L.Circle,{size:s,className:c});
const fmtD=(ds)=>{ const d=new Date(ds+'T12:00:00'); return d.toLocaleDateString('es',{weekday:'short',day:'numeric'}).toUpperCase(); }

class ErrorBoundary extends Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
  render() {
    if (this.state.hasError) {
      return h('div', {className: "h-screen w-screen flex flex-col items-center justify-center bg-black text-white p-4 text-center"},
        Icon('AlertTriangle', 48, "text-red-500 mb-4"),
        h('h1', {className: "text-2xl font-bold mb-2"}, "Error de Interfaz"),
        h('button', {onClick: () => { localStorage.clear(); window.location.reload(); }, className: "bg-red-600 px-6 py-2 rounded font-bold hover:bg-red-700"}, "Reiniciar App (Borrar Datos)")
      );
    }
    return this.props.children;
  }
}

function App(){
    const [tabs,ST]=useState(TABS);
    const [act,SA]=useState('t1');
    const [date,SD]=useState(new Date());
    const [evs,SE]=useState([]); 
    const [cals,SC]=useState({}); 
    
    const [projs, SProjs] = useState([]);
    const [curProjId, SCurProjId] = useState(null);
    const [projAnim, SProjAnim] = useState('idle');
    const [addingRes, SAddingRes] = useState(false);
    
    const [modal,SM]=useState(null); 
    const [selId,SSI]=useState(null);
    const [form,SF]=useState({title:'',date:'',time:'',type:'gen',notes:'',cat:'task',quad:'q2',notify:0});
    
    const [resForm, SResForm] = useState({ content: '' });

    const [sets,SS]=useState(false);
    const [bioShow,SBS]=useState(false);
    const [guideShow, SGS_Guide] = useState(false);
    const [sync,SSy]=useState(false);
    const [gCfg,SG]=useState({apiKey:'',clientId:''});
    const [gSign,SGS]=useState(false);
    const [dH,SH]=useState(40);
    const [drag,SDr]=useState(false);
    const [dir,SDir]=useState('n');
    const [dTask, SDT] = useState(null); 
    const [dragOverQ, SDQ] = useState(null); 
    const [confirmDel, SConfirm] = useState(null);
    const [exitingIds, setExitingIds] = useState(new Set());
    const [deleting, setDeleting] = useState(false);
    const [saving, setSaving] = useState(false);
    const [wikiData, setWikiData] = useState(null);
    const [loadingBio, setLoadingBio] = useState(false);
    const [bioError, setBioError] = useState(false);

    const fM=useRef(new Set());
    const tC=useRef(null);
    const gI=useRef(false); 
    const gsI=useRef(false); 
    const tS=useRef(null);
    const tE=useRef(null);
    const dY=useRef(0);
    const dH0=useRef(0);

    const curTab=tabs.find(t=>t.id===act)||tabs[0];
    const thStyle={'--theme-color':curTab.c};

    useEffect(()=>{
        const e=localStorage.getItem('ev_v14');
        const t=localStorage.getItem('tb_v9');
        const g=localStorage.getItem('gc_v9');
        const c=localStorage.getItem('cm_v9');
        const p=localStorage.getItem('pj_v2'); 
        if(e) try{ SE(JSON.parse(e) || []) }catch(x){ SE([]) } 
        if(t) try{ ST(JSON.parse(t)) }catch(x){ ST(TABS) }
        if(g) try{ SG(JSON.parse(g)) }catch(x){ SG({apiKey:'',clientId:''}) }
        if(c) try{ SC(JSON.parse(c)) }catch(x){ SC({}) }
        if(p) try{ SProjs(JSON.parse(p) || []) }catch(x){ SProjs([]) }
        if(!window.gapi) {
            const script = document.createElement('script');
            script.src = "https://apis.google.com/js/api.js";
            script.onload = () => { if(window.gapi) window.gapi.load('client', initGapi); };
            document.body.appendChild(script);
        } else { window.gapi.load('client', initGapi); }
    },[]);
    
    useEffect(()=>{ localStorage.setItem('ev_v14',JSON.stringify(evs)) },[evs]);
    useEffect(()=>{ localStorage.setItem('tb_v9',JSON.stringify(tabs)) },[tabs]);
    useEffect(()=>{ localStorage.setItem('gc_v9',JSON.stringify(gCfg)) },[gCfg]);
    useEffect(()=>{ localStorage.setItem('cm_v9',JSON.stringify(cals)) },[cals]);
    useEffect(()=>{ localStorage.setItem('pj_v2',JSON.stringify(projs)) },[projs]);

    useEffect(() => {
        if(gSign && gCfg.apiKey) {
            const k = `${date.getFullYear()}-${date.getMonth()}`;
            if(!fM.current.has(k)) fetchG(date);
        }
    }, [date, gSign]);

    const initGapi = async () => {
        if(gCfg.apiKey && window.gapi && !gI.current){
            try { await window.gapi.client.init({apiKey: gCfg.apiKey, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}); gI.current = true; } 
            catch(e) { console.warn("GAPI Init Error", e); }
        }
    };
    
    const initGis = () => {
        if(gCfg.clientId && window.google && window.google.accounts && !gsI.current){
            try {
                tC.current = window.google.accounts.oauth2.initTokenClient({
                    client_id: gCfg.clientId, scope: "https://www.googleapis.com/auth/calendar.events",
                    callback: (r) => {
                        if(r.error) { alert("Error Auth: " + r.error); return; }
                        if(window.gapi && window.gapi.client) window.gapi.client.setToken(r);
                        SGS(true); fM.current.clear(); fetchG(date); 
                    }
                }); gsI.current = true;
            } catch(e) { console.warn("GIS Init Error", e); }
        }
    };
    
    const auth = async () => {
        if(!gCfg.apiKey || !gCfg.clientId) return alert("Configura API Key y Client ID primero.");
        if(!gI.current) await initGapi();
        if(!gsI.current) initGis();
        if(tC.current) tC.current.requestAccessToken({prompt: 'select_account'});
    };

    const fetchG = async (td = new Date()) => {
        if(!gSign || !window.gapi || !window.gapi.client) return;
        SSy(true);
        try {
            if(!window.gapi.client.calendar) await window.gapi.client.load('calendar','v3');
            const y = td.getFullYear(), m = td.getMonth();
            const minIso = new Date(y, m-1, 1).toISOString();
            const maxIso = new Date(y, m+2, 0, 23, 59, 59).toISOString();
            fM.current.add(`${y}-${m}`); fM.current.add(`${y}-${m-1}`); fM.current.add(`${y}-${m+1}`); 

            const calListReq = await window.gapi.client.calendar.calendarList.list();
            const calItems = calListReq.result.items || [];
            const nextCals = {};
            calItems.forEach(c => { nextCals[c.id] = { id: c.id, summary: c.summary, color: c.backgroundColor, visible: cals[c.id]?.visible ?? true }; });
            SC(nextCals);

            const promises = calItems.map(c => {
                if(nextCals[c.id] && !nextCals[c.id].visible) return Promise.resolve([]);
                return window.gapi.client.calendar.events.list({ calendarId: c.id, timeMin: minIso, timeMax: maxIso, singleEvents: true, maxResults: 250, orderBy: 'startTime' })
                  .then(res => ({ id: c.id, items: res.result.items || [], color: c.backgroundColor }))
                  .catch(err => ({ id: c.id, items: [], error: err }));
            });

            const results = await Promise.allSettled(promises);
            const newGoogleEvents = [];
            results.forEach(res => {
                if(res.status === 'fulfilled' && Array.isArray(res.value.items)) {
                    res.value.items.forEach(i => {
                        if(!i || i.status === 'cancelled') return;
                        const start = i.start || {};
                        const dRaw = start.dateTime || start.date;
                        if(!dRaw) return; 
                        const dateStr = dRaw.includes('T') ? dRaw.split('T')[0] : dRaw;
                        const timeStr = start.dateTime ? start.dateTime.split('T')[1].substring(0,5) : '';
                        let cat = 'task', q = 'q2';
                        const titleLower = (i.summary || '').toLowerCase();
                        if (i.recurringEventId || i.recurrence || titleLower.includes('clase') || titleLower.includes('aula') || titleLower.includes('reunión')) { cat = 'class'; q = null; }
                        newGoogleEvents.push({ id: i.id, calId: res.value.id, title: i.summary || '(Sin título)', date: dateStr, time: timeStr, type: 'google', notes: i.description || '', cat, quad: q, gCol: res.value.color });
                    });
                }
            });

            SE(prev => {
                const local = prev.filter(e => e.type !== 'google');
                const mergedMap = new Map();
                const minTime = new Date(minIso).getTime();
                const maxTime = new Date(maxIso).getTime();
                prev.filter(e => e.type === 'google').forEach(e => {
                    const eTime = new Date(e.date).getTime();
                    if (eTime < minTime || eTime > maxTime) mergedMap.set(e.id, e);
                });
                local.forEach(e => mergedMap.set(e.id, e));
                newGoogleEvents.forEach(e => mergedMap.set(e.id, e));
                return Array.from(mergedMap.values());
            });

        } catch(e) { console.error("Sync Error", e); } finally { SSy(false); }
    };

    const days = useMemo(() => {
        if(!date || isNaN(date.getTime())) return [];
        const y=date.getFullYear(),m=date.getMonth();
        const d=[];
        const last=new Date(y,m+1,0).getDate();
        const firstDay = new Date(y,m,1).getDay();
        const pad = (firstDay === 0 ? 7 : firstDay) - 1; 
        for(let i=0;i<pad;i++) d.push({d:'', dt:null});
        for(let i=1;i<=last;i++) d.push({d:i, dt:locDate(new Date(y,m,i))});
        return d;
    }, [date]);

    const {lk, mx, upGrouped} = useMemo(() => {
        const l={}, m=[], u=[], now=locDate(new Date());
        (evs || []).forEach(e => {
            if(!e) return;
            if(e.type === 'google' && cals[e.calId] && cals[e.calId].visible === false) return;
            if(e.date) { if(!l[e.date]) l[e.date] = []; l[e.date].push(e); }
            if(e.cat !== 'class' && e.cat !== 'fitness') m.push(e);
            if(e.date >= now) u.push(e);
        });
        const gr={}; 
        u.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time)).slice(0, 50).forEach(e => {
            if(!gr[e.date]) gr[e.date] = []; gr[e.date].push(e);
        });
        return { lk: l, mx: m, upGrouped: Object.entries(gr) };
    }, [evs, cals]);

    const fetchWikiBio = async () => {
        SBS(true); setLoadingBio(true); setBioError(false); setWikiData(null);
        const query = SPECIES_LIST[Math.floor(Math.random() * SPECIES_LIST.length)];
        const taxonomy = TAXONOMY_DB[query];
        try {
            const url = `https://es.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts|pageimages&piprop=original|thumbnail&pithumbsize=600&exintro&explaintext&titles=${query}`;
            const res = await fetch(url);
            const data = await res.json();
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            const pageData = pages[pageId];
            if (pageId === "-1") throw new Error("No encontrado");
            const imgUrl = pageData.original?.source || pageData.thumbnail?.source || null;
            setWikiData({ title: pageData.title, desc: pageData.extract, img: imgUrl, tax: taxonomy });
        } catch (e) { console.error(e); setBioError(true); } finally { setLoadingBio(false); }
    };
    
    const getDescBlocks = (text) => {
        if(!text) return ["Sin descripción disponible."];
        return text.match(/[^.!?]+[.!?]+/g) || [text];
    };
    
    useEffect(() => {
        if (!dTask) return;
        const move = (e) => {
            const t = e.touches ? e.touches[0] : e;
            e.preventDefault(); 
            SDT(p => ({ ...p, x: t.clientX, y: t.clientY }));
            const el = document.elementFromPoint(t.clientX, t.clientY);
            const qD = el?.closest('[data-quad]');
            SDQ(qD ? qD.getAttribute('data-quad') : null);
        };
        const end = (e) => {
            const t = e.changedTouches ? e.changedTouches[0] : e;
            const el = document.elementFromPoint(t.clientX, t.clientY);
            const qD = el?.closest('[data-quad]');
            if (qD) {
                const nQ = qD.getAttribute('data-quad');
                if (nQ === 'q4') SConfirm({id: dTask.id, title: dTask.title, type: dTask.type, calId: dTask.calId}); 
                else if (nQ !== dTask.startQuad) SE(p => p.map(x => x.id === dTask.id ? { ...x, quad: nQ } : x));
            }
            SDT(null); SDQ(null);
        };
        window.addEventListener('touchmove', move, { passive: false });
        window.addEventListener('touchend', end);
        return () => { window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end); };
    }, [dTask]);

    const confirmDelete = async () => { 
        if(!confirmDel) return;
        const { id, type, calId } = confirmDel;
        setDeleting(true); 
        if (type === 'google' && window.gapi && window.gapi.client) {
            try { await window.gapi.client.calendar.events.delete({ calendarId: calId, eventId: id }); } 
            catch (err) { alert("No se pudo eliminar de Google Calendar. Revisa permisos."); setDeleting(false); return; }
        }
        setDeleting(false); SConfirm(null); setExitingIds(prev => new Set(prev).add(id));
        setTimeout(() => { SE(prev => prev.filter(e => e.id !== id)); setExitingIds(prev => { const n = new Set(prev); n.delete(id); return n; }); }, 700); 
    };

    const handleSave = async () => {
        setSaving(true);
        const newId = modal === 'c' ? Date.now() : selId;
        let newEvent = { ...form, id: newId, type: 'local', gCol: null };
        if (modal === 'c' && gSign && gCfg.apiKey && window.gapi && window.gapi.client) {
            try {
                const startDateTime = new Date(`${form.date}T${form.time}`).toISOString();
                const endDateTime = new Date(new Date(`${form.date}T${form.time}`).getTime() + 60*60*1000).toISOString(); 
                const resource = { summary: form.title, description: form.notes, start: { dateTime: startDateTime }, end: { dateTime: endDateTime } };
                const res = await window.gapi.client.calendar.events.insert({ calendarId: 'primary', resource: resource });
                newEvent = { ...newEvent, id: res.result.id, type: 'google', calId: 'primary', gCol: '#4285F4' }; 
            } catch (err) { console.warn("Could not sync to Google, saving locally", err); }
        }
        SE(prev => modal === 'c' ? [...prev, newEvent] : prev.map(e => e.id === selId ? { ...newEvent, id: selId } : e)); 
        setSaving(false); SM(null);
    };

    const getYouTubeId = (url) => {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    };

    const addProject = () => {
        if(!form.title) return;
        if(modal === 'ep' && curProjId) {
            SProjs(projs.map(p => p.id === curProjId ? {...p, title: form.title, color: form.color || p.color} : p));
        } else {
            const newProj = { id: Date.now(), title: form.title, color: form.color || '#22c55e', resources: [] };
            SProjs([...projs, newProj]);
        }
        SM(null); SF({title:'',date:'',time:'',type:'gen',notes:'',cat:'task',quad:'q2',notify:0});
    };

    const addResource = async () => {
        if(!resForm.content) return;
        SAddingRes(true);
        const content = resForm.content.trim();
        let type = 'note', icon = 'FileText', color = '#FBBC04', thumb = null, title = content;
        
        const ytId = getYouTubeId(content);
        if (ytId) {
            type = 'video'; icon = 'Youtube'; color = '#FF0000'; thumb = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
            try {
                const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${ytId}`);
                const data = await res.json();
                if(data.title) title = data.title;
            } catch(e) { console.warn("NoEmbed failed", e); }
        } 
        else if(content.includes('drive.google.com')) { type = 'drive'; icon = 'Cloud'; color = '#34A853'; }
        else if(content.includes('.pdf')) { type = 'pdf'; icon = 'File'; color = '#EA4335'; }
        else if(content.startsWith('http')) { type = 'link'; icon = 'ExternalLink'; color = '#3b82f6'; }

        const newRes = { id: Date.now(), type, icon, color, content, title, thumb, date: new Date().toISOString() };
        SProjs(projs.map(p => p.id === curProjId ? { ...p, resources: [...p.resources, newRes] } : p));
        SAddingRes(false); SM(null); SResForm({ content: '' });
    };

    const deleteResource = (rId) => {
        if(confirm('¿Eliminar recurso?')) SProjs(projs.map(p => p.id === curProjId ? { ...p, resources: p.resources.filter(r => r.id !== rId) } : p));
    };

    const deleteProject = (pId) => {
        if(confirm('¿Eliminar proyecto y todos sus contenidos?')) SProjs(projs.filter(p => p.id !== pId));
    }

    const openProject = (pId) => {
        SProjAnim('entering');
        SCurProjId(pId);
        setTimeout(() => SProjAnim('idle'), 250); 
    };

    const closeProject = () => {
        SProjAnim('exiting');
        // Faster unmount to reduce lag perception
        setTimeout(() => {
            SCurProjId(null);
            SProjAnim('idle');
        }, 200);
    };
    
    const editProject = () => {
        const p = projs.find(x => x.id === curProjId);
        if(p) { SF({title: p.title, color: p.color}); SM('ep'); }
    }

    const currentProject = projs.find(p => p.id === curProjId);

    // --- RENDER HELPERS ---
    
    // FLAT FOLDER (Minimalist)
    const renderFolder = (p) => {
        return h('div', {
            key: p.id,
            onClick: () => openProject(p.id),
            className: "group flex flex-col items-center gap-2 cursor-pointer card-press"
        },
            // Flat Colored Container
            h('div', { 
                className: "w-[72px] h-[72px] md:w-[90px] md:h-[90px] rounded-[22px] flex items-center justify-center shadow-lg transition-transform",
                style: { backgroundColor: p.color }
            },
                Icon('Folder', 32, "text-black/30") 
            ),
            h('span', { className: "text-[11px] md:text-xs font-medium text-white/90 text-center truncate w-full px-1" }, p.title),
            
            h('button', {
                onClick: (e) => { e.stopPropagation(); deleteProject(p.id); },
                className: "absolute top-0 right-0 bg-neutral-800 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20 -mr-2 -mt-2 shadow-lg border border-white/10"
            }, Icon('X', 10, "text-white"))
        );
    };

    // Big Icon Resource Card
    const renderResourceCard = (r) => {
        const isVideo = r.type === 'video';
        return h('div', {
            key: r.id,
            onClick: () => r.type !== 'note' && window.open(r.content, '_blank'),
            className: "relative aspect-square md:aspect-[4/3] rounded-2xl overflow-hidden bg-neutral-900/60 border border-white/5 shadow-xl flex flex-col card-press cursor-pointer group"
        },
            h('div', { className: `flex-1 w-full relative overflow-hidden ${isVideo ? 'bg-black' : 'bg-gradient-to-br from-white/5 to-transparent flex items-center justify-center'}` },
                isVideo && r.thumb 
                ? h('img', { src: r.thumb, className: "w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" })
                : Icon(r.icon, 56, `text-[${r.color}] drop-shadow-[0_10px_20px_${r.color}40]`) // Bigger Icon
            ),
            
            h('div', { className: "h-[50px] shrink-0 bg-white/5 backdrop-blur-md p-3 flex items-center justify-between" },
                h('div', { className: "flex-1 min-w-0 pr-2" },
                    h('p', { className: "text-[11px] font-bold text-white truncate leading-tight" }, r.title || r.content),
                    h('span', { className: "text-[9px] text-neutral-500 uppercase tracking-wider" }, r.type)
                ),
                h('button', {
                    onClick: (e) => { e.stopPropagation(); deleteResource(r.id); },
                    className: "text-neutral-600 hover:text-red-500 transition-colors"
                }, Icon('Trash2', 14))
            )
        );
    }

    return h('div',{className:"h-screen w-screen bg-[#000] text-slate-200 font-sans overflow-hidden flex flex-col relative selection:bg-[var(--theme-color)] selection:text-black",style:thStyle},
        h('div',{className:"absolute inset-0 pointer-events-none"},
            h('div',{className:"absolute inset-0 opacity-10",style:{backgroundImage:`radial-gradient(circle at 50% 0%,var(--theme-color),transparent 80%)`}}),
            h('div',{className:"absolute inset-0 opacity-[0.03]",style:{backgroundImage:`linear-gradient(#fff 1px,transparent 1px),linear-gradient(90deg,#fff 1px,transparent 1px)`,backgroundSize:'50px 50px'}})
        ),
        
        h('header',{className:"z-20 flex flex-col pt-2 bg-black/80 border-b border-white/5 shrink-0 backdrop-blur-md relative"},
            h('div',{className:"flex overflow-x-auto no-scrollbar px-4 gap-2"}, tabs.map(t=>
                h('button',{key:t.id,onClick:()=>{SA(t.id);if(t.id!=='t4')SCurProjId(null)},style:{borderColor:act===t.id?t.c:'transparent',color:act===t.id?t.c:'#525252',backgroundColor:act===t.id?t.c+'08':'transparent'},className:"flex items-center gap-2 px-6 py-4 rounded-t-lg text-sm font-black tracking-widest transition-all border-b-2 safe-hover active:bg-white/5 uppercase shrink-0 outline-none"},Icon(t.i),t.l)
            )),
            h('button',{onClick:()=>SGS_Guide(true), className:"absolute top-3 right-4 p-2 text-neutral-600 hover:text-white transition-colors"}, Icon('Info', 18))
        ),

        h('main',{className:"flex-1 px-2 pb-2 md:px-6 md:pb-8 overflow-hidden flex flex-col z-10"},
            h('div',{className:"py-4 flex justify-between shrink-0"},
                h('div',{className:"flex items-baseline gap-2"},
                    h('h1',{className:"text-3xl md:text-5xl font-black text-white tracking-tighter leading-none drop-shadow-lg"}, 
                        act==='t4' ? (curProjId ? currentProject?.title.toUpperCase() : 'BIBLIOTECA') 
                        : act==='t2'?"MATRIZ":date.toLocaleString('es-ES',{month:'long'}).toUpperCase()
                    ),
                    act==='t1'&&h('span',{className:"text-neutral-600 font-bold text-2xl"},date.getFullYear())
                ),
                h('div',{className:"flex gap-3"},
                    act==='t4' ? (
                        curProjId 
                        ? h('button', {onClick: () => SM('nr'), className: "flex items-center gap-2 px-4 py-2 bg-[var(--theme-color)] text-black font-bold rounded-full shadow-[0_0_15px_var(--theme-color)] hover:brightness-110 active:scale-95 transition-all"}, Icon('Plus', 18), "Añadir")
                        : h('button', {onClick: () => SM('np'), className: "flex items-center gap-2 px-4 py-2 bg-white/10 border border-white/20 text-white font-bold rounded-full hover:bg-white/20 active:scale-95 transition-all"}, Icon('Plus', 18), "Carpeta")
                    ) : (
                        act==='t1'&&h('button',{onClick:()=>SD(new Date()),className:"hidden md:block px-4 py-1 text-xs font-bold text-neutral-400 border border-neutral-800 rounded bg-neutral-900 safe-hover"},"HOY")
                    ),
                    
                    act!=='t4' && h('button',{onClick:gSign?()=>fetchG(date):auth,className:`flex items-center gap-2 px-3 py-2 rounded bg-neutral-900 border active:scale-95 outline-none ${sync?'border-[var(--theme-color)] text-[var(--theme-color)]':'border-neutral-800 text-neutral-400'}`},Icon('RefreshCw',18,sync?'animate-spin':''),h('span',{className:"hidden md:inline text-[10px] font-black"},"SYNC")),
                    h('button',{onClick:()=>SS(true),className:"p-2.5 rounded bg-neutral-900 border border-neutral-800 text-neutral-400 safe-hover active:scale-95 outline-none"},Icon('Settings',20))
                )
            ),
            
            act==='t4' ? (
                h('div', { className: "flex-1 overflow-hidden relative" },
                    
                    !curProjId && h('div', { 
                        className: `absolute inset-0 overflow-y-auto p-4 content-start grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-x-4 gap-y-8 ${projAnim === 'exiting' ? 'zoom-exit' : 'zoom-enter'}` 
                    },
                        projs.map(p => renderFolder(p)),
                        projs.length === 0 && h('div', { className: "col-span-full flex flex-col items-center justify-center opacity-30 mt-20" },
                            Icon('Folder', 64, "mb-4 stroke-[1]"),
                            h('span', { className: "text-sm font-mono" }, "Sin proyectos activos")
                        )
                    ),
                    
                    curProjId && currentProject && h('div', { 
                        className: `absolute inset-0 bg-black/60 backdrop-blur-2xl flex flex-col z-20 ${projAnim === 'entering' ? 'zoom-enter' : projAnim === 'exiting' ? 'zoom-exit' : ''}` 
                    },
                        h('div', { className: "flex items-center justify-between p-4 border-b border-white/5 bg-white/5 backdrop-blur-xl shrink-0" },
                            h('div',{className:"flex items-center gap-4"},
                                h('button', { onClick: closeProject, className: "p-2 rounded-full hover:bg-white/10 text-white active:scale-90 transition-all flex items-center gap-1" }, 
                                    Icon('ArrowLeft', 20), h('span',{className:"text-sm font-bold"},"Atrás")
                                ),
                                h('div', {},
                                    h('h2', { className: "text-lg font-black text-white tracking-tight" }, currentProject.title),
                                    h('span', { className: "text-[10px] font-mono text-neutral-400" }, `${currentProject.resources.length} ITEMS`)
                                )
                            ),
                            h('button', {onClick: editProject, className:"p-2 rounded-full hover:bg-white/10 text-neutral-400"}, Icon('Edit3', 18))
                        ),
                        
                        h('div', { className: "flex-1 overflow-y-auto p-6" },
                            h('div', { className: "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" },
                                currentProject.resources.map(r => renderResourceCard(r)),
                                currentProject.resources.length === 0 && h('div', { className: "col-span-full flex flex-col items-center justify-center py-20 text-neutral-600" },
                                    Icon('Plus', 48, "mb-4 opacity-20"),
                                    h('p', { className: "text-sm" }, "Carpeta vacía"),
                                    h('p', { className: "text-xs opacity-50" }, "Añade un link, video o nota")
                                )
                            )
                        )
                    )
                )
            ) : act==='t2' 
            ? h('div',{className:"flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-3 pb-20 md:pb-0 relative"}, 
                dTask && h('div',{
                    className:"fixed pointer-events-none z-[999] bg-black/90 border p-3 rounded hover:border-white/20 flex gap-3 w-64 backdrop-blur-md shadow-2xl", 
                    style:{left:dTask.x, top:dTask.y, transform:'translate(-50%, -50%) rotate(3deg)', borderColor: Q[dTask.startQuad]?.c || 'white'}
                },
                    h('div',{className:"mt-0.5"},Icon('CheckCircle',14,`text-[${Q[dTask.startQuad]?.c}]`)),
                    h('p',{className:"flex-1 text-xs font-bold text-slate-200 truncate"}, dTask.title),
                    Icon('GripHorizontal',14, "text-neutral-600")
                ),
                Object.keys(Q).map(k=>{
                    const isOver=dragOverQ===k, isDel=k==='q4';
                    const quadrantEvents = mx.filter(e=>(e.quad||'q2')===k);
                    return h('div',{key:k,'data-quad':k, className:`${isOver?(isDel?'border-red-500 bg-red-900/30 scale-[1.02] shadow-[0_0_30px_rgba(220,38,38,0.3)]':'border-[var(--theme-color)] bg-[var(--theme-color)]/10 scale-[1.02] shadow-[0_0_30px_var(--theme-color)]'):'border-neutral-800 bg-neutral-900/40'} border rounded-xl p-3 flex flex-col relative overflow-hidden backdrop-blur-sm transition-all duration-200`},
                        h('div',{className:"flex justify-between items-center mb-3 pb-2 border-b border-white/5"},h('h3',{className:"text-xs font-black tracking-[0.2em] uppercase",style:{color:Q[k].c}},Q[k].t),h('span',{className:"bg-black/50 text-neutral-400 text-[10px] font-mono px-2 py-0.5 rounded"},quadrantEvents.length)),
                        h('div',{className:"flex-1 overflow-y-auto space-y-2 no-scrollbar"}, quadrantEvents.map(e=>
                            h('div',{key:e.id, onClick:()=>{SF({...e});SSI(e.id);SM('e')}, className:`bg-black/80 border border-white/5 p-3 rounded hover:border-white/20 transition-all flex gap-3 group relative ${dTask?.id===e.id ? 'opacity-30' : ''} ${exitingIds.has(e.id)?'anim-purge':''}`},
                                h('div',{className:"mt-0.5"},Icon('CheckCircle',14,`text-[${Q[k].c}]`)),
                                h('p',{className:"flex-1 text-xs font-bold text-slate-200 truncate"},e.title),
                                h('div',{className:"text-neutral-600 cursor-grab active:cursor-grabbing p-1 -m-1", onTouchStart:(ev)=>{
                                    SDT({...e, x:ev.touches[0].clientX, y:ev.touches[0].clientY, startQuad:k, type: e.type, calId: e.calId})
                                }}, Icon('GripHorizontal',14))
                            )
                        ))
                    )
                })
            ) 
            : h('div',{onTouchStart:e=>{tE.current=null;tS.current=e.targetTouches[0].clientX},onTouchMove:e=>tE.current=e.targetTouches[0].clientX,onTouchEnd:()=>{if(!tS.current||!tE.current)return; const d=tS.current-tE.current; if(Math.abs(d)>50){SDir(d>0?'n':'p');SD(new Date(date.getFullYear(),date.getMonth()+(d>0?1:-1),1));}},className:"flex-1 bg-black/40 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden flex flex-col relative shadow-2xl"}, 
                h('div',{className:"grid grid-cols-7 bg-white/5 border-b border-white/5"},['L','M','X','J','V','S','D'].map(d=>h('div',{key:d,className:"py-3 text-center text-[10px] font-black tracking-widest text-neutral-500"},d))),
                h('div',{key:date.toISOString(),className:`grid grid-cols-7 flex-1 auto-rows-fr ${dir==='n'?'anim-n':'anim-p'}`, style:{willChange:'transform, opacity'}}, days.map((d,i)=>{ 
                    const isToday = d.dt === locDate(new Date()); 
                    return h('div',{key:d.dt||i,onClick:()=>{if(d.dt){SF({title:'',date:d.dt,time:'09:00',type:'gen',notes:'',cat:'task',quad:'q2',notify:0});SM('c')}},className:`relative border-r border-b border-white/5 p-1 transition-colors hover:bg-white/5 cursor-pointer outline-none ${isToday?'bg-[var(--theme-color)]/5':''}`},
                        d.d&&h('span',{className:`text-xs font-bold flex items-center justify-center w-6 h-6 rounded ${isToday?'bg-[var(--theme-color)] text-black shadow-[0_0_10px_var(--theme-color)]':'text-neutral-500'}`},d.d),
                        h('div',{className:"mt-1 flex flex-col gap-1"}, (lk[d.dt]||[]).map(e=>
                            h('div',{key:e.id,onClick:ev=>{ev.stopPropagation();SF({...e});SSI(e.id);SM('e')},className:"text-[9px] font-bold truncate px-1.5 py-0.5 rounded-r border-l-2 bg-white/5 text-slate-300 hover:text-white hover:bg-white/10 transition-colors",style:{borderLeftColor:e.gCol||curTab.c}}, e.time+' '+e.title)
                        ))
                    )
                }))
            )
        ),

        act !== 't4' && h('div',{className:`fixed bottom-0 left-0 right-[60px] z-50 rounded-tr-2xl glass flex flex-col ${!drag?'tr-h':''}`,style:{height:dH}},
            h('div',{className:"w-full h-6 flex justify-center items-center cursor-grab touch-none shrink-0",onTouchStart:e=>{SDr(true);dY.current=e.touches[0].clientY;dH0.current=dH},onTouchMove:e=>{if(drag)SH(Math.min(window.innerHeight-50,Math.max(40,dH0.current+(dY.current-e.touches[0].clientY))))},onTouchEnd:()=>{SDr(false);const h=window.innerHeight;SH(dH>h*.75?h-20:dH>h*.3?h*.5:40)}},h('div',{className:"w-12 h-1 bg-white/20 rounded-full"})),
            h('div',{className:`flex-1 overflow-x-auto p-4 flex gap-4 no-scrollbar fade-content ${dH<80?'opacity-0 pointer-events-none':'opacity-100'}`}, upGrouped.length?upGrouped.map(([dStr,evs])=>
                h('div',{key:dStr,className:"flex flex-col gap-2 min-w-[220px]"},
                    h('div',{className:"sticky top-0 z-10"},h('span',{className:"text-[9px] font-black tracking-widest text-[var(--theme-color)] bg-black/80 px-2 py-1 rounded border border-[var(--theme-color)]/30"},fmtD(dStr))),
                    evs.map(e=>h('div',{key:e.id,onClick:()=>{SF({...e});SSI(e.id);SM('e')},className:"w-full bg-neutral-900/80 border border-white/10 border-l-4 p-3 rounded hover:bg-neutral-800 cursor-pointer",style:{borderLeftColor:e.gCol||'white'}},
                        h('div',{className:"flex justify-between items-start mb-1"},
                            h('div',{className:"flex flex-col overflow-hidden"},
                                h('span',{className:"text-[8px] font-bold uppercase tracking-wider opacity-60 truncate mb-0.5", style:{color: e.gCol}}, cals[e.calId]?.summary || 'BioZen'),
                                h('span',{className:"text-xs font-bold text-white truncate"},e.title)
                            ),
                            h('span',{className:"text-[9px] text-neutral-500 font-mono whitespace-nowrap ml-2"},e.time)
                        )
                    ))
                )
            ):h('div',{className:"w-full text-center text-neutral-600 text-xs italic mt-10"},"Sin eventos próximos"))
        ),

        h('div',{onClick:fetchWikiBio,className:`fixed bottom-0 right-0 w-32 z-[60] flex items-center justify-center cursor-pointer active:bg-white/10 safe-hover overflow-hidden rounded-tl-[32px] group backdrop-blur-md ${!drag?'tr-h':''}`,style:{height:dH,background:'rgba(0,0,0,0.6)',borderLeft:`1px solid ${curTab.c}80`,borderTop:`1px solid ${curTab.c}80`,boxShadow:`inset 5px 5px 20px ${curTab.c}10`}},
            Icon('Dna',24,`group-active:animate-spin text-[${curTab.c}] drop-shadow-[0_0_8px_${curTab.c}]`)
        ),

        (modal || confirmDel || sets || bioShow || guideShow) && h('div',{id:'modal-root',className:"bg-black/90 backdrop-blur-md flex items-center justify-center p-4"},
            
            (modal === 'np' || modal === 'ep') && h('div',{className:"w-full max-w-sm ios-glass rounded-3xl overflow-hidden shadow-2xl flex flex-col animate-pulse-fast", style:{animation:'none'}},
                h('div',{className:"p-4 bg-white/5 border-b border-white/5 flex justify-between"},h('span',{className:"font-black text-white tracking-widest"}, modal==='ep'?"EDITAR":"NUEVO PROYECTO"),h('button',{onClick:()=>SM(null)},Icon('X'))),
                h('div',{className:"p-5 space-y-4"},
                    h('input',{autoFocus:true,placeholder:"Nombre...",className:"w-full bg-black/40 border border-white/10 rounded-xl p-3 text-white font-bold outline-none focus:border-[var(--theme-color)] transition-all",value:form.title,onChange:e=>SF({...form,title:e.target.value})}),
                    h('div',{className:"flex justify-between items-center"},
                         h('span',{className:"text-sm text-neutral-400"},"Color"),
                         h('input',{type:'color',value:form.color||'#22c55e',onChange:e=>SF({...form,color:e.target.value}),className:"w-10 h-10 rounded border-none bg-transparent cursor-pointer"})
                    ),
                    h('button',{onClick:addProject,className:"w-full py-3 rounded-xl bg-[var(--theme-color)] text-black font-black hover:scale-[1.02] transition-transform shadow-[0_0_20px_var(--theme-color)]"},"GUARDAR")
                )
            ),

            modal === 'nr' && h('div',{className:"w-full max-w-sm ios-glass rounded-3xl overflow-hidden shadow-2xl flex flex-col"},
                h('div',{className:"p-4 bg-white/5 border-b border-white/5 flex justify-between"},h('span',{className:"font-black text-white tracking-widest"},"AÑADIR RECURSO"),h('button',{onClick:()=>SM(null)},Icon('X'))),
                h('div',{className:"p-5 space-y-4"},
                    h('div',{className:"text-xs text-neutral-400 bg-white/5 p-3 rounded-xl border border-white/5"}, 
                        "Pega un link de YouTube, Drive o PDF. Detectaremos título y miniatura automáticamente."
                    ),
                    h('textarea',{autoFocus:true,rows:3,placeholder:"https://...",className:"w-full bg-black/40 border border-white/10 rounded-xl p-3 text-sm text-white outline-none focus:border-[var(--theme-color)] transition-all",value:resForm.content,onChange:e=>SResForm({...resForm,content:e.target.value})}),
                    h('button',{onClick:addResource, disabled: addingRes, className:"w-full py-3 rounded-xl bg-[var(--theme-color)] text-black font-black hover:scale-[1.02] transition-transform flex justify-center items-center gap-2"},
                        addingRes ? Icon('RefreshCw', 18, "animate-spin") : "GUARDAR"
                    )
                )
            ),

            guideShow && h('div',{className:"w-full max-w-lg bg-zinc-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col"},
                h('div',{className:"p-4 border-b border-neutral-700 flex justify-between bg-zinc-950 items-center"}, 
                    h('h3',{className:"font-black text-white tracking-widest flex items-center gap-2"}, Icon('Zap',16,"text-[var(--theme-color)]"), "MODO ZEN: UNIVERSIDAD"), 
                    h('button',{onClick:()=>SGS_Guide(false)},Icon('X',20,"text-white"))
                ),
                h('div',{className:"p-6 space-y-6 overflow-y-auto max-h-[70vh] text-sm text-neutral-300"},
                    h('div',{},
                        h('h4',{className:"font-bold text-white mb-2 flex items-center gap-2"}, Icon('Calendar',14,"text-blue-500"), "1. CALENDARIO & SINCRONIZACIÓN"),
                        h('p',{className:"mb-2"}, "Esta herramienta es independiente, pero se comunica con tu Google Calendar.")
                    ),
                    h('div',{},
                        h('h4',{className:"font-bold text-white mb-2 flex items-center gap-2"}, Icon('Folder',14,"text-green-500"), "3. GESTOR DE PROYECTOS"),
                        h('p',{className:"mb-2"}, "Pega links de YouTube y se verán como videos con miniatura. Organiza todo en carpetas visuales.")
                    )
                )
            ),

            sets && h('div',{className:"w-full max-w-2xl max-h-[85vh] bg-zinc-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col relative"},
                h('div',{className:"p-4 border-b border-neutral-700 flex justify-between bg-zinc-950"}, h('h3',{className:"font-bold text-white"},"CONFIGURACIÓN"), h('button',{onClick:()=>SS(false)},Icon('X',20,"text-white"))),
                h('div',{className:"p-6 space-y-8 overflow-y-auto bg-zinc-900"},
                     h('div',{},h('h4',{className:"text-xs font-bold text-neutral-500 uppercase border-b border-neutral-800 pb-2"},"Sistema"),
                        h('button',{onClick:async()=>{if('Notification' in window) await Notification.requestPermission()},className:"mt-4 w-full flex items-center justify-between p-3 bg-neutral-800 rounded border border-neutral-700 hover:border-white/20 transition-all"},h('span',{className:"text-sm text-white font-bold"},"Activar Notificaciones"),Icon('Bell',16))
                     ),
                     h('div',{},h('h4',{className:"text-xs font-bold text-neutral-500 uppercase border-b border-neutral-800 pb-2"},"Calendarios Google"),
                        Object.values(cals).length ? Object.values(cals).map(c=>h('div',{key:c.id,className:"flex justify-between items-center p-3 border-b border-neutral-800 hover:bg-white/5"},h('span',{className:"text-sm font-bold",style:{color:c.color}},c.summary),h('button',{onClick:()=>SC(p=>({...p,[c.id]:{...p[c.id],visible:!p[c.id].visible}}))},Icon(c.visible?'Eye':'EyeOff',16,'text-neutral-400')))) : h('div',{className:"text-xs text-neutral-600 mt-2 italic"},"No hay calendarios sincronizados")
                     ),
                     h('div',{},h('h4',{className:"text-xs font-bold text-neutral-500 uppercase border-b border-neutral-800 pb-2"},"Estética"),
                        tabs.map(t=>h('div',{key:t.id,className:"flex items-center justify-between mt-3 p-2 rounded hover:bg-white/5"},
                            h('div',{className:"flex items-center gap-3"}, Icon(t.i,18,"text-neutral-400"), h('span',{className:"text-sm font-bold text-neutral-300"}, t.l)),
                            h('input',{type:'color',value:t.c,onChange:e=>ST(tabs.map(tb=>tb.id===t.id?{...tb,c:e.target.value}:tb)),className:"w-8 h-8 rounded border-none bg-transparent cursor-pointer"})
                        ))
                     ),
                     h('div',{},h('h4',{className:"text-xs font-bold text-neutral-500 uppercase border-b border-neutral-800 pb-2"},"Google API"),
                        h('div',{className:"space-y-3 mt-3"},
                            h('div',{className:"flex items-center gap-2 bg-black border border-neutral-700 rounded p-2"}, Icon('Database',14,'text-neutral-500'), h('input',{placeholder:"Client ID",value:gCfg.clientId,onChange:e=>SG({...gCfg,clientId:e.target.value}),className:"w-full bg-transparent text-xs text-white outline-none"})),
                            h('div',{className:"flex items-center gap-2 bg-black border border-neutral-700 rounded p-2"}, Icon('Key',14,'text-neutral-500'), h('input',{placeholder:"API Key",value:gCfg.apiKey,onChange:e=>SG({...gCfg,apiKey:e.target.value}),className:"w-full bg-transparent text-xs text-white outline-none"}))
                        )
                     )
                )
            ),

            bioShow && h('div',{className:"w-full max-w-5xl h-[85vh] md:h-[650px] bg-black border border-white/20 rounded-xl overflow-hidden flex flex-col md:flex-row relative shadow-[0_0_50px_rgba(0,0,0,1)]"},
                h('button',{onClick:()=>SBS(false),className:"absolute top-4 right-4 z-50 p-2 bg-black/60 rounded-full text-white hover:text-red-400 border border-white/10 backdrop-blur safe-hover"},Icon('X', 18)),
                
                loadingBio ? h('div',{className:"absolute inset-0 z-50 flex flex-col items-center justify-center bg-black text-white"},
                    h('div',{className:"w-16 h-16 border-4 border-t-[var(--theme-color)] border-neutral-800 rounded-full animate-spin mb-4"}),
                    h('p',{className:"text-sm font-mono tracking-widest animate-pulse"}, "ANALIZANDO MUESTRA..."),
                    h('p',{className:"text-xs text-neutral-500 mt-2"}, "Conectando con Wikipedia API")
                ) : bioError ? h('div',{className:"absolute inset-0 z-50 flex flex-col items-center justify-center bg-black text-red-500"},
                    Icon('WifiOff', 48, "mb-4 opacity-50"),
                    h('h3',{className:"text-xl font-bold"}, "ERROR DE ENLACE"),
                    h('button',{onClick:fetchWikiBio, className:"mt-6 px-6 py-2 bg-white/10 rounded hover:bg-white/20 text-white"}, "Reintentar")
                ) : wikiData && h(F, null,
                    h('div',{className:"w-full md:w-5/12 h-1/3 md:h-full relative bg-zinc-900 overflow-hidden group"},
                        wikiData.img ? h('img',{src:wikiData.img,className:"w-full h-full object-cover opacity-80"}) 
                        : h('div',{className:"w-full h-full flex items-center justify-center bg-[#111]"}, Icon('Dna', 64, "text-neutral-700 animate-pulse")),
                        h('div',{className:"absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"}),
                        h('div',{className:"scan-line"}),
                        h('div',{className:"absolute bottom-6 left-6 right-6 z-20"},
                             h('div',{className:"flex items-center gap-2 mb-2"},
                                h('div',{className:"w-2 h-2 rounded-full animate-pulse",style:{background:curTab.c}}),
                                h('span',{className:"text-[10px] font-mono tracking-widest text-white/70 uppercase"},"Wiki Data Link")
                            ),
                            h('h2',{className:"text-3xl md:text-4xl font-black text-white italic tracking-tighter leading-none mb-1 drop-shadow-2xl"}, wikiData.title.toUpperCase())
                        )
                    ),
                    h('div',{className:"w-full md:w-7/12 flex flex-col bg-[#050505] relative hud-grid"},
                         h('div',{className:"flex items-center justify-between p-4 border-b border-white/10 bg-white/5"},
                            h('button',{onClick:fetchWikiBio, className:"flex items-center gap-2 px-3 py-1.5 bg-[var(--theme-color)]/20 border border-[var(--theme-color)] text-[var(--theme-color)] text-xs font-bold rounded hover:bg-[var(--theme-color)] hover:text-black transition-all"}, Icon('RefreshCw', 12), "Siguiente Muestra"),
                            h('div',{className:"flex items-center gap-2"}, Icon('Globe',14,"text-blue-500"), h('span',{className:"text-[10px] text-neutral-500 uppercase"}, "Wikipedia API"))
                        ),
                        h('div',{className:"flex-1 overflow-y-auto p-6 space-y-8 no-scrollbar"},
                            h('div',{className:"space-y-3"},
                                h('h4',{className:"text-[10px] font-black text-neutral-500 uppercase tracking-[0.2em] flex items-center gap-2"}, Icon('Activity',12), "Clasificación Taxonómica"),
                                h('div',{className:"grid grid-cols-2 md:grid-cols-3 gap-[1px] bg-white/10 border border-white/10 rounded overflow-hidden"},
                                    Object.entries(wikiData.tax).map(([k,v])=>
                                        h('div',{key:k, className:"bg-[#0c0c0e] p-3 flex flex-col group hover:bg-[#151518] transition-colors"},
                                            h('span',{className:"text-[9px] text-neutral-600 font-bold uppercase mb-1 tracking-wider"}, 
                                                k==='k'?'Reino':k==='p'?'Filo':k==='c'?'Clase':k==='o'?'Orden':k==='f'?'Familia':k==='g'?'Género':k
                                            ),
                                            h('span',{className:"text-xs font-mono truncate",style:{color:curTab.c}}, v)
                                        )
                                    )
                                )
                            ),
                            h('div',{className:"space-y-4"},
                                h('h4',{className:"text-[10px] font-black text-neutral-500 uppercase tracking-[0.2em] flex items-center gap-2"}, Icon('BookOpen',12), "Informe Descriptivo"),
                                h('div',{className:"grid gap-3"},
                                    getDescBlocks(wikiData.desc).map((block, i) =>
                                        h('div',{key:i, className:"bg-white/5 p-4 rounded border-l-2 border-[var(--theme-color)]/50 hover:bg-white/10 transition-colors"},
                                            h('p',{className:"text-sm text-neutral-300 leading-relaxed"}, block)
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            ),
            
            (modal === 'e' || modal === 'c') && !confirmDel && !sets && !bioShow && !guideShow && h('div',{className:"w-full max-w-md bg-zinc-900 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl flex flex-col"},
                h('div',{className:"p-4 bg-black/50 border-b border-neutral-800 flex justify-between"},h('span',{className:"font-black text-white tracking-widest"},modal==='e'?'EDITAR':'NUEVO'),h('button',{onClick:()=>SM(null)},Icon('X'))),
                h('div',{className:"p-5 space-y-4"},
                    h('input',{autoFocus:true,placeholder:"Título...",className:"w-full bg-black/50 border border-neutral-700 rounded p-3 text-white font-bold outline-none focus:border-[var(--theme-color)]",value:form.title,onChange:e=>SF({...form,title:e.target.value})}),
                    h('div',{className:"grid grid-cols-2 gap-3"},h('input',{type:'date',className:"bg-black/50 border border-neutral-700 rounded p-2 text-white",value:form.date,onChange:e=>SF({...form,date:e.target.value})}),h('input',{type:'time',className:"bg-black/50 border border-neutral-700 rounded p-2 text-white",value:form.time,onChange:e=>SF({...form,time:e.target.value})})),
                    h('div',{className:"flex gap-2"},[{id:'task',l:'TAREA'},{id:'class',l:'CLASE'},{id:'fitness',l:'FIT'}].map(c=>h('button',{key:c.id,onClick:()=>SF({...form,cat:c.id}),className:`flex-1 py-2 rounded text-[10px] font-black tracking-widest ${form.cat===c.id?'bg-[var(--theme-color)] text-black':'bg-neutral-800 text-neutral-400'}`},c.l))),
                    h('textarea',{rows:3,className:"w-full bg-black/50 border border-neutral-700 rounded p-3 text-sm text-neutral-300 outline-none focus:border-[var(--theme-color)]",placeholder:"Notas...",value:form.notes,onChange:e=>SF({...form,notes:e.target.value})}),
                    h('button',{onClick:handleSave,className:"w-full py-3 rounded bg-[var(--theme-color)] text-black font-black hover:brightness-110 flex justify-center gap-2"}, saving ? Icon('RefreshCw',18,'animate-spin') : h('span',{},"CONFIRMAR"))
                )
            )
        )
    );
}

const root=createRoot(document.getElementById('root'));
root.render(h(ErrorBoundary, null, h(App)));
</script>
<script>if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));</script>
</body>
</html>
